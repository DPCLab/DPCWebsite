$(document).ready(function(){$("#loading").hide()});var typingTimer,MAX_CHARACTERS=240,$input=$(".troll-detector .text");function isEnteredKey(e){return 9==e||13==e||32==e||e>=48&&e<=90||e>=96&&e<=111||e>=186&&e<=192||e>=219&&e<=222}function check_characters(e){$(".character-limit").html($input.text().length+"/240"),isEnteredKey(e.which)&&$input.text().length>=MAX_CHARACTERS&&e.preventDefault()}$input.on("keyup",function(e){check_characters(e),isEnteredKey(e.which)&&(clearTimeout(typingTimer),typingTimer=setTimeout(function(){analyzeTweet()},300))}),$input.on("keydown",function(e){check_characters(e),isEnteredKey(e.which)&&($input.children("span").css("background-color","#ffffff"),clearTimeout(typingTimer))});var colorSwatch=["#3A539B","#647AB3","#8FA2CC","#B9C9E5","#E4F1FE","#F1A9A0","#F08B85","#F06E6A","#F0514F","#F03434"];function drawPie(e){var t=[{value:1-Math.abs(e),color:"#e8e8e8"},{value:Math.abs(e),color:colorSwatch[Math.floor(5*(e+1))]}],n=d3.pie().value(function(e){return e.value}).sort(null),o=d3.arc().outerRadius(10).innerRadius(10/1.5);d3.select("#troll-pie").selectAll("*").remove(),d3.select("#troll-pie").append("svg").attr("width",20).attr("height",20).append("g").attr("transform","translate(10,10)").selectAll("path").data(n(t)).enter().append("path").attr("fill",function(e,t){return e.data.color}).attr("stroke","white").attr("d",o)}function addHighlighting(e,t){highlighted_text=e;for(var n=Object.keys(t),o=0;o<n.length;o++)if(Math.abs(t[n[o]])>.3){var a="("+n[o]+")([^<]|$)";highlighted_text=highlighted_text.replace(new RegExp(a),"<span data-proba = '"+t[n[o]]+"' class = 'hover' style = 'background-color:"+colorSwatch[Math.floor(5*(t[n[o]]+1))]+"50'>$1</span>$2")}return highlighted_text}function analyzeTweet(e){$(".hover-box").remove(),tweet_text=$input.text(),tweet_text.length>0?($("#loading").fadeIn(),$.get("https://ru.dpccdn.net/analyze/"+encodeURI(tweet_text),function(e){if(drawPie(e.master),e.master>0?$(".is-troll").html("Leans Troll"):$(".is-troll").html("Leans Non-Troll"),$(".text").html(addHighlighting(tweet_text,e.tokenized)),el=document.getElementById("text"),el.focus(),void 0!==window.getSelection&&void 0!==document.createRange){var t=document.createRange();t.selectNodeContents(el),t.collapse(!1);var n=window.getSelection();n.removeAllRanges(),n.addRange(t)}else if(void 0!==document.body.createTextRange){var o=document.body.createTextRange();o.moveToElementText(el),o.collapse(!1),o.select()}$("#troll-pie").removeClass("hidden"),$("#loading").fadeOut()})):($(".is-troll").html("Please enter your text below"),$("#troll-pie").addClass("hidden"),$("#loading").fadeOut())}$(document).on("mouseover",".hover",function(e){var t=(100*parseFloat($(this).data("proba"))).toFixed(2)+"%";0==$(this).has(".hover-box").length&&$(this).append("<div class = 'hover-box'><strong>"+(parseFloat($(this).data("proba"))>0?"Leans Troll":"Leans Non-Troll")+"</strong> ("+t+")</div>")}),$(document).on("mouseleave",".hover",function(e){$(this).children(".hover-box").remove()});