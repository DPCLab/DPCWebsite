var typingTimer,MAX_CHARACTERS=240,$input=$(".troll-detector .text");function isMobile(){return window.innerWidth<720}function isEnteredKey(e){return 9==e||13==e||32==e||e>=48&&e<=90||e>=96&&e<=111||e>=186&&e<=192||e>=219&&e<=222}function check_characters(e){$(".character-limit").html($input.text().length+"/240"),isEnteredKey(e.which)&&$input.text().length>=MAX_CHARACTERS&&e.preventDefault(),0==$input.text().length&&($(".is-troll").html("Please enter your text below"),$("#troll-pie").addClass("hidden"),$("#loading").fadeOut(),$(".placeholder").show())}function onKeyDown(e){check_characters(e),isEnteredKey(e.which)&&(clearTimeout(typingTimer),$("#loading").fadeIn(),$(".placeholder").hide(),$input.children("span").css("background-color","#ffffff00"),typingTimer=setTimeout(function(){analyzeTweet(e)},1e3))}isMobile()&&$(".placeholder").remove(),$(document).ready(function(){$("#loading").hide();var e=new URL(window.location.href).searchParams.get("text");null!=e&&e.length>0&&($(".placeholder").hide(),$input.html(decodeURI(e)),analyzeTweet()),isMobile()||new Typed("#title",{strings:["How do trolls talk?","How do trolls divide?","How do trolls lie?","How do trolls tweet?","How do trolls type?","How do trolls sound?","How do trolls anger?","How do trolls hate?"],typeSpeed:45,backDelay:2e3,smartBackspace:!0,loop:!0})}),$input.on("keyup input",check_characters),$input.on("keydown input",onKeyDown);var colorSwatch=["#3A539B","#647AB3","#8FA2CC","#B9C9E5","#E4F1FE","#F1A9A0","#F08B85","#F06E6A","#F0514F","#F03434"],pieColors=["#3A539B","#F03434"];function drawPie(e){var t=[{value:1-Math.abs(e),color:"#e8e8e8"},{value:Math.abs(e),color:pieColors[Math.round((e+1)/2)]}],o=d3.pie().value(function(e){return e.value}).sort(null),l=d3.arc().outerRadius(10).innerRadius(10/1.5);d3.select("#troll-pie").selectAll("*").remove(),d3.select("#troll-pie").append("svg").attr("width",20).attr("height",20).append("g").attr("transform","translate(10,10)").selectAll("path").data(o(t)).enter().append("path").attr("fill",function(e,t){return e.data.color}).attr("d",l),$("#troll-pie").removeClass("hidden")}function addHighlighting(e,t){for(var o=e.split(/([^A-Z0-9])/gi),l=Object.keys(t),n="",r=0;r<o.length;r++)-1!=l.indexOf(o[r])?n+="<span data-proba = '"+t[o[r]]+"' class = 'hover' style = 'background-color:"+(Math.abs(t[o[r]])<.2?"#ffffff00":colorSwatch[Math.floor(5*(t[o[r]]+1))]+"50")+"'>"+o[r]+"</span>":n+=o[r];return n}function getTokenDescriptor(e){return e>0?"More troll-like than organic":e<0?"More organic than troll-like":"No effect"}function analyzeTweet(e){$(".hover-box").remove(),$("#troll-pie").addClass("hidden"),tweet_text=$input.text(),tweet_text.length>0?$.get("https://ru.dpccdn.net/analyze/"+encodeURIComponent(tweet_text.replace(/\//g,"")),function(t){0!=t.master&&drawPie(t.master);var o=(100*t.master).toFixed(2)+"%";if(t.master>0?$(".is-troll").html(`More troll-like than organic (${o})`):0==t.master?$(".is-troll").html(`Not enough information (${o})`):$(".is-troll").html(`More organic than troll-like (${o})`),$input.text()==tweet_text?$(".text").html(addHighlighting(tweet_text,t.tokenized)):onKeyDown(e),el=document.getElementById("text"),el.focus(),void 0!==window.getSelection&&void 0!==document.createRange){var l=document.createRange();l.selectNodeContents(el),l.collapse(!1);var n=window.getSelection();n.removeAllRanges(),n.addRange(l)}else if(void 0!==document.body.createTextRange){var r=document.body.createTextRange();r.moveToElementText(el),r.collapse(!1),r.select()}$("#loading").fadeOut()}):($(".is-troll").html("Please enter your text below"),$("#troll-pie").addClass("hidden"),$("#loading").fadeOut(),$(".placeholder").show())}$(document).on("mouseover",".hover",function(e){var t=(100*parseFloat($(this).data("proba"))).toFixed(2)+"%";0==$(this).has(".hover-box").length&&$(this).append("<div class = 'hover-box'><strong>"+getTokenDescriptor(parseFloat($(this).data("proba")))+"</strong> ("+t+")</div>")}),$(document).on("mouseleave",".hover",function(e){$(this).children(".hover-box").remove()});